<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Update movie details and rating">
    <title>Edit Movie: {{ movie.title }}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="bg-gray-100 min-h-screen font-sans">

    <!-- Header -->
    <header class="bg-indigo-700 shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Movie Tracker</h1>

            <nav class="flex items-center space-x-4">
                <a href="{{ url_for('movie_list') }}"
                   class="px-3 py-1.5 bg-indigo-500 text-white rounded-full
                          text-sm font-semibold hover:bg-indigo-400
                          transition duration-150">
                    ‚Üê Back to List
                </a>

                <span class="text-white text-sm font-medium hidden sm:inline">
                    Logged in as:
                    <strong class="text-indigo-200">{{ g.user.username }}</strong>
                </span>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6 space-y-2 max-w-2xl mx-auto">
                    {% for category, message in messages %}
                        <div class="px-4 py-3 rounded-lg relative
                            {% if category == 'success' %}
                                bg-green-100 border border-green-400 text-green-700
                            {% elif category == 'danger' %}
                                bg-red-100 border border-red-400 text-red-700
                            {% else %}
                                bg-blue-100 border border-blue-400 text-blue-700
                            {% endif %}"
                            role="alert">
                            <strong class="font-bold">{{ category | capitalize }}!</strong>
                            <span class="block sm:inline ml-2">{{ message }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Main Content -->
        <div class="w-full max-w-2xl mx-auto bg-white shadow-2xl rounded-2xl p-6 sm:p-8 space-y-6">

            <!-- Page Title -->
            <h2 class="text-3xl font-extrabold text-gray-800 border-b pb-4">
                Edit: <span class="text-indigo-600">{{ movie.title }}</span>
            </h2>

            <!-- Movie Info Card -->
            <article class="border border-indigo-200 rounded-xl p-4 flex gap-4 bg-indigo-50/50">
                <img src="{{ movie.poster_url | default('https://placehold.co/80x120/8b5cf6/ffffff?text=No+Poster', true) }}"
                     alt="Poster for {{ movie.title }}"
                     class="w-20 h-30 rounded-lg shadow-md object-cover flex-shrink-0"
                     onerror="this.onerror=null;this.src='https://placehold.co/80x120/8b5cf6/ffffff?text=No+Poster';"
                     loading="lazy"
                     width="80"
                     height="120">

                <div class="flex-grow">
                    <p class="text-lg font-semibold text-gray-800">
                        {{ movie.title }} ({{ movie.year }})
                    </p>
                    <p class="text-sm text-gray-600">
                        Director: {{ movie.director }}
                    </p>
                    <p class="text-xs text-gray-500 mt-2">
                        Current Rating:
                        <strong>{{ movie.rating }}/5</strong>
                    </p>
                </div>
            </article>

            <!-- Update Form -->
            <form method="POST"
                  action="{{ url_for('movie_update', movie_id=movie.id) }}"
                  id="movieForm"
                  class="space-y-6">

                <!-- 1. Status Dropdown -->
                <div>
                    <label for="status" class="block text-lg font-medium text-gray-700 mb-2">
                        üì∫ Viewing Status
                    </label>
                    <select id="status"
                            name="status"
                            required
                            class="mt-1 block w-full border border-gray-300 rounded-xl
                                   shadow-sm p-3 focus:ring-indigo-500
                                   focus:border-indigo-500 bg-white transition duration-150">
                        {% set statuses = ['Planning to Watch', 'Watching', 'Watched'] %}
                        {% for s in statuses %}
                            <option value="{{ s }}"
                                    {% if movie.status == s %}selected{% endif %}>
                                {{ s }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 2. Star Rating -->
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-3">
                        ‚≠ê Your Rating (Click Stars)
                    </label>

                    <!-- Star Container -->
                    <div class="star-rating" id="starContainer">
                        {% for i in range(1, 6) %}
                            <span class="star" data-value="{{ i }}">‚òÖ</span>
                        {% endfor %}
                    </div>

                    <!-- Rating Display -->
                    <span class="rating-info">
                        <strong id="ratingValue">{{ movie.rating | default(0) }}</strong>/5
                    </span>

                    <!-- Hidden Input (submitted value) -->
                    <input type="hidden"
                           name="rating"
                           id="ratingInput"
                           value="{{ movie.rating | default(0) }}">
                </div>

                <!-- 3. Personal Review -->
                <div>
                    <label for="plot" class="block text-lg font-medium text-gray-700 mb-2">
                        üìù Personal Review / Notes
                    </label>
                    <textarea id="plot"
                              name="plot"
                              rows="5"
                              required
                              class="mt-1 block w-full border border-gray-300 rounded-xl
                                     shadow-sm p-3 focus:ring-indigo-500
                                     focus:border-indigo-500 transition duration-150"
                              placeholder="Write your thoughts about this movie...">{{ movie.plot | default('') }}</textarea>
                </div>

                <!-- Submit Button -->
                <div>
                    <button type="submit"
                            class="w-full bg-indigo-600 text-white font-bold py-4 px-6
                                   rounded-xl hover:bg-indigo-700 transition duration-200
                                   shadow-lg text-lg transform hover:scale-[1.02]
                                   active:scale-[0.98]">
                        üíæ Save Changes
                    </button>
                </div>
            </form>

        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-8 py-4 text-center text-sm text-gray-500">
        &copy; 2025 Movie Tracker
    </footer>

    <!-- Star Rating JavaScript (FIXED VERSION) -->
    <script>
        (function() {
            'use strict';

            // Get elements
            const stars = document.querySelectorAll('.star');
            const ratingInput = document.getElementById('ratingInput');
            const ratingValue = document.getElementById('ratingValue');
            const form = document.getElementById('movieForm');
            const starContainer = document.getElementById('starContainer');

            // Validate all elements exist
            if (!stars.length) {
                console.error('‚ùå No star elements found');
                return;
            }
            if (!ratingInput) {
                console.error('‚ùå ratingInput not found');
                return;
            }
            if (!ratingValue) {
                console.error('‚ùå ratingValue not found');
                return;
            }
            if (!form) {
                console.error('‚ùå movieForm not found');
                return;
            }
            if (!starContainer) {
                console.error('‚ùå starContainer not found');
                return;
            }

            // Initialize with current rating
            let currentRating = parseInt(ratingInput.value) || 0;

            console.log('üé¨ Movie Rating Script Loaded');
            console.log('üìä Initial rating:', currentRating);
            console.log('‚≠ê Found', stars.length, 'stars');

            /**
             * Update star display and input value
             */
            function updateStars(rating) {
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('filled');
                        star.classList.remove('hover');
                    } else {
                        star.classList.remove('filled', 'hover');
                    }
                });

                // Update text display and hidden input
                ratingValue.textContent = rating;
                ratingInput.value = rating;

                console.log('‚≠ê Updated to:', rating);
            }

            /**
             * Handle hover effect
             */
            function handleHover(hoverValue) {
                stars.forEach((star, index) => {
                    if (index < hoverValue) {
                        star.classList.add('hover');
                    } else {
                        star.classList.remove('hover');
                    }
                });
            }

            // Initialize display
            updateStars(currentRating);

            // Add click handlers
            stars.forEach((star, index) => {
                star.addEventListener('click', function() {
                    const value = parseInt(this.getAttribute('data-value'));

                    console.log('üñ±Ô∏è Clicked star:', value);

                    // Toggle: clicking same rating sets to 0
                    if (value === currentRating) {
                        currentRating = 0;
                    } else {
                        currentRating = value;
                    }

                    updateStars(currentRating);
                });

                // Hover effect
                star.addEventListener('mouseenter', function() {
                    const hoverValue = parseInt(this.getAttribute('data-value'));
                    handleHover(hoverValue);
                });
            });

            // Reset hover on mouse leave
            starContainer.addEventListener('mouseleave', function() {
                updateStars(currentRating);
            });

            // Form submit handler (optional confirmation)
            form.addEventListener('submit', function(e) {
                console.log('üì§ SUBMITTING FORM');
                console.log('   Rating value:', ratingInput.value);
                console.log('   Status:', document.getElementById('status').value);
                console.log('   Plot length:', document.getElementById('plot').value.length);

                // Optional: Add confirmation dialog
                // Uncomment if you want confirmation on save
                /*
                const confirmation = confirm(
                    `Save changes with rating: ${ratingInput.value}/5?`
                );
                if (!confirmation) {
                    e.preventDefault();
                }
                */
            });

            console.log('‚úÖ Rating system initialized successfully');

        })();
    </script>

    <!-- Auto-hide flash messages after 5 seconds -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('[role="alert"]');

            flashMessages.forEach(function(message) {
                setTimeout(function() {
                    message.style.transition = 'opacity 0.5s ease-out';
                    message.style.opacity = '0';

                    setTimeout(function() {
                        message.remove();
                    }, 500);
                }, 5000);
            });
        });
    </script>

</body>
</html>